# Missing User in Database Issue

## Problem

User is authenticated via NextAuth but doesn't exist in the database:

```
User vcavkho4CFhVAmsqe_iYr not found in database
```

This causes:

- ❌ "No cluster assigned" error on participants page
- ❌ Cannot access cluster-specific features
- ❌ Session works but database operations fail

## Root Cause

Your NextAuth session has a user ID (`vcavkho4CFhVAmsqe_iYr`), but this user
record was never created in your `users` table. This typically happens when:

1. User was created in an external auth system (Clerk) but not synced to your
   database
2. User login succeeded but user creation step failed
3. Database migration removed the user record

## Solution Options

### Option 1: Use the Dashboard (Recommended)

1. **Logout** the current user
2. Login as a **super_admin** user
3. Go to **Users** page in the dashboard
4. Click **Add User** button
5. Fill in the form with the correct details:
   - Email: (the user's actual email)
   - Name: (the user's actual name)
   - Role: `user` (or appropriate role)
   - Password: (set a temporary password)
   - Assign to cluster
6. Ask the user to login with the new credentials

### Option 2: Run the Database Script

We've created helper scripts in `/scripts/` directory:

#### Step 1: Create the User

```bash
# Edit the script first to add correct user details
pnpm tsx scripts/create-missing-user.ts
```

**Before running**, edit `scripts/create-missing-user.ts` and update:

- Line 31: User's real name
- Line 32: User's email address
- Line 33: Set a secure password
- Line 34: Set appropriate role

#### Step 2: Assign to Cluster

```bash
# Edit the script first to set cluster ID
pnpm tsx scripts/assign-user-to-cluster.ts
```

**Before running**, edit `scripts/assign-user-to-cluster.ts` and update:

- Line 72: Set the cluster ID (from clusters table)
- Line 73: Set the role (`user`, `cluster_manager`, etc.)

### Option 3: SQL Direct Insert (Advanced)

```sql
-- Insert user with ID matching the NextAuth session
INSERT INTO users (id, name, email, password, role, created_at, updated_at)
VALUES (
  'vcavkho4CFhVAmsqe_iYr',
  'User Name',  -- CHANGE THIS
  'user@example.com',  -- CHANGE THIS
  '$2a$10$...',  -- Hashed password (use bcrypt)
  'user',
  NOW(),
  NOW()
);

-- Assign to a cluster
INSERT INTO cluster_users (user_id, cluster_id, role, created_at, updated_at)
VALUES (
  'vcavkho4CFhVAmsqe_iYr',
  'YOUR_CLUSTER_ID',  -- Get from clusters table
  'user',
  NOW(),
  NOW()
);
```

## Verification Steps

After creating the user, verify:

1. **User exists in database**:

```sql
SELECT id, name, email, role FROM users WHERE id = 'vcavkho4CFhVAmsqe_iYr';
```

2. **User is assigned to a cluster**:

```sql
SELECT cu.*, c.name as cluster_name
FROM cluster_users cu
JOIN clusters c ON cu.cluster_id = c.id
WHERE cu.user_id = 'vcavkho4CFhVAmsqe_iYr';
```

3. **Login and test**:
   - Login with the user credentials
   - Navigate to `/dashboard/participants`
   - Should see participants data (no "no cluster assigned" error)

## Prevention

To prevent this in the future:

1. **Always create users through the dashboard** - This ensures proper database
   sync
2. **Don't use external auth IDs directly** - User IDs should be generated by
   your system
3. **Implement user sync webhook** - If using external auth, add a webhook to
   sync users to database automatically

## Related Files

- `/scripts/create-missing-user.ts` - Helper script to create missing users
- `/scripts/assign-user-to-cluster.ts` - Helper script to assign users to
  clusters
- `/src/features/auth/actions.ts` - Contains `getUserClusterId()` function
- `/src/app/dashboard/participants/page.tsx` - Shows "no cluster assigned" error

## Status

⚠️ **ACTION REQUIRED** - User needs to be created in the database before they
can access cluster-specific features.
